---
layout: post
title: 8. ëª½ê³ ë””ë¹„
author: admin
date: 2023-04-26 00:00:00 +900
lastmod: 2023-04-26 00:00:00 +900
sitemap:
  changefreq: monthly
  priority: 0.5
categories: [NODE, NODEJSêµê³¼ì„œ] # ëŒ€ë¬¸ìë¡œ ì‘ì„±
tags: [node, nodejs, ë…¸ë“œêµê³¼ì„œ] # ì†Œë¬¸ìë¡œ ì‘ì„±
---

> ê¸°ì¡´ ë¸”ë¡œê·¸ì— ì‘ì„±í–ˆë˜ í¬ìŠ¤íŠ¸ë¥¼ ì´ì „í•œ ê¸€ì…ë‹ˆë‹¤.
{:.prompt-info}

> í•´ë‹¹ í¬ìŠ¤íŠ¸ëŠ” `NODEJS`ë¥¼ í•™ìŠµí•˜ë©° ì •ë¦¬í•œ ë‚´ìš©ì— ëŒ€í•œ í¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.
{:.prompt-info}

<br/>

---

<br/>

# **ğŸŒˆ ëª½ê³ ë””ë¹„**

## **ğŸ’» NoSQL vs SQL**

MySQLê°™ì€ SQL ë°ì´í„°ë² ì´ìŠ¤ì™€ëŠ” ë‹¤ë¥¸ ìœ í˜•ì˜ ë°ì´í„°

- NoSQLì˜ ëŒ€í‘œì£¼ìì¸ mongoDB(ëª½ê³ ë””ë¹„) ì‚¬ìš©

- JOIN: ê´€ê³„ê°€ ìˆëŠ” í…Œì´ë¸”ë¼ë¦¬ ë°ì´í„°ë¥¼ í•©ì¹˜ëŠ” ê¸°ëŠ¥(ëª½ê³ ë””ë¹„ aggregateë¡œ í‰ë‚´ ê°€ëŠ¥)

- ë¹…ë°ì´í„°, ë©”ì‹œì§•, ì„¸ì…˜ ê´€ë¦¬ ë“±(ë¹„ì •í˜• ë°ì´í„°)ì—ëŠ” ëª½ê³ ë””ë¹„ ì‚¬ìš©í•˜ë©´ ì¢‹ìŒ

|SQL(MySQL)|NoSQL(ëª½ê³ ë””ë¹„)|
|:-|:-|
|ê·œì¹™ì— ë§ëŠ” ë°ì´í„° ì…ë ¥|ììœ ë¡œìš´ ë°ì´í„° ì…ë ¥|
|í…Œì´ë¸” ê°„ JOIN ì§€ì›|ì»¬ë ‰ì…˜ ê°„ JOIN ë¯¸ì§€ì›|
|ì•ˆì •ì„±, ì¼ê´€ì„±|í™•ì¥ì„±, ê°€ìš©ì„±|
|ìš©ì–´(í…Œì´ë¸”, ë¡œìš°, ì»¬ëŸ¼)|ìš©ì–´(ì»¬ë ‰ì…˜, ë‹¤íë¨¼íŠ¸, í•„ë“œ)|

<br/>

---

<br/>

## **ğŸ’» ëª½ê³ ë””ë¹„ ì„¤ì¹˜í•˜ê¸°**

>[ëª½ê³ ë””ë¹„ ê³µì‹ ì‚¬ì´íŠ¸](https://www.mongodb.com/try/download/community){:target="_blank"}ì—ì„œ ë‚´ë ¤ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br/>

### **ğŸ³ ëª½ê³ ë””ë¹„ ì—°ê²°í•˜ê¸°**

ìœˆë„ì˜ ê²½ìš° C:\ì— data í´ë”ë¥¼ ë§Œë“¤ê³  ê·¸ ì•ˆì— db í´ë”ë¥¼ ë§Œë“¦

ì½˜ì†”ë¡œ ëª½ê³ ë””ë¹„ê°€ ì„¤ì¹˜ëœ ê²½ë¡œ(ê¸°ë³¸ì ìœ¼ë¡œ C:\Program Files\MongoDB\Server\6.0\bin)ë¡œ ì´ë™í•´ ëª½ê³ ë””ë¹„ë¥¼ ì‹¤í–‰

```sh
mongod --ipv6
```

![ëª½ê³ ë””ë¹„ë¥¼ ì‹¤í–‰](https://github.com/leekoby/leekoby.github.io/assets/118284808/2b984449-8add-471c-ab89-f0241962739e)

>[ëª½ê³ ë””ë¹„ ì…¸ë„ ì„¤ì¹˜](https://mongodb.com/try/download/shell){:target="_blank"}

mongod ê°€ ì‹¤í–‰ ì¤‘ì¸ ìƒíƒœì—ì„œ mongosh ì‹¤í–‰ 

![mongosh](https://github.com/leekoby/leekoby.github.io/assets/118284808/6d15e35c-f192-4211-a605-59e889022592)

<br/>

### **ğŸ³ ì–´ë“œë¯¼ ì„¤ì •í•˜ê¸°**

ì–´ë“œë¯¼ ê¶Œí•œì„ ì„¤ì •í•˜ì—¬ ë””ë¹„ì— ë¹„ë°€ë²ˆí˜¸ ê±¸ê¸°

```sh
test> use admin
switched to db admin
admin> db.createUser({ user: 'ì´ë¦„', pwd: 'ë¹„ë°€ë²ˆí˜¸', roles: ['root'] })
Successfully added user: { "user" : "root", "roles" : [ "root" ] }
```

mongodë¥¼ ì…ë ¥í–ˆë˜ ì½˜ì†”ì„ ì¢…ë£Œí•œ í›„ `mongod --ipv6 --auth` ëª…ë ¹ì–´ë¡œ ì ‘ì†

- `--auth`ëŠ” ë¡œê·¸ì¸ì´ í•„ìš”í•˜ë‹¤ëŠ” ëœ»

mongosh ì½˜ì†”ë„ ì¢…ë£Œí•œ í›„ `mongosh admin -u ì´ë¦„ -p ë¹„ë°€ë²ˆí˜¸` ëª…ë ¹ì–´ë¡œ ì ‘ì†

```sh
$ mongosh admin -u [ì´ë¦„] -p [ë¹„ë°€ë²ˆí˜¸]
Current Mongosh Log ID: 62f9d501a04fc0bcbc7f2791
Connecting to:          mongodb://<credentials>@127.0.0.1:27017/admin?directConnection=true&serverSelectionTimeoutMS=2000&appName=mongosh+1.5.4
Using MongoDB:          6.0.0
Using Mongosh:          1.5.4
(ìƒëµ)
admin>
```

ë°©ê¸ˆ ì…ë ¥í•œ ëª…ë ¹ì–´ëŠ” ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ ìƒì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸í•˜ê¸° ìœ„í•œ ê²ƒì´ì—ˆìœ¼ë¯€ë¡œ, ì•ìœ¼ë¡œ ëª½ê³ ë””ë¹„ í”„ë¡¬í”„íŠ¸ë¥¼ ì´ìš©í•  ë•ŒëŠ” ë‹¨ìˆœíˆ mongoshë§Œ ì…ë ¥í•˜ë©´ ëœë‹¤.

<br/>

---

<br/>

## **ğŸ’» COMPASS**

ì»´í¼ìŠ¤ë„ [ëª½ê³ ë””ë¹„ ê³µì‹ ì‚¬ì´íŠ¸](https://mongodb.com/download-center/compass){:target="_blank"}ì—ì„œ ë‹¤ìš´ë°›ì„ ìˆ˜ ìˆë‹¤. 

<br/>

### **ğŸ³ ì»¤ë„¥ì…˜ ìƒì„±í•˜ê¸°**

ì»´í¼ìŠ¤(MongoDB Compass Community)ë¡œ ì ‘ì†

Authentication ì„ Username/Passwordë¡œ ë³€ê²½, ëª½ê³ ë””ë¹„ ê³„ì • ì´ë¦„ê³¼ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥

![ì»¤ë„¥ì…˜ ìƒì„±í•˜ê¸°](https://github.com/leekoby/leekoby.github.io/assets/118284808/211606e4-7bf1-464c-aa94-2dfb8405aec4)

<br/>

---

<br/>

## **ğŸ’» ë°ì´í„°ë² ì´ìŠ¤ ë° ì»¬ë ‰ì…˜ ìƒì„±í•˜ê¸°**

ëª½ê³ ë””ë¹„ í”„ë¡¬í”„íŠ¸ì— ì ‘ì†í•œ í›„ ì§„í–‰í•˜ë©´ ëœë‹¤.

ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë§Œë“œëŠ” ëª…ë ¹ì–´ëŠ” `use [ë°ì´í„°ë² ì´ìŠ¤ëª…]`ì…ë‹ˆë‹¤.

```sh
> use nodejs
switched to db nodejs
```

ë°ì´í„°ë² ì´ìŠ¤ ëª©ë¡ì„ í™•ì¸í•˜ëŠ” ëª…ë ¹ì–´ëŠ” `show dbs`

```sh
> show dbs
admin 0.000GB
config 0.000GB
local 0.000GB
```

ë°©ê¸ˆ ìƒì„±í•œ nodejsê°€ ì—†ì§€ë§Œ ë‹¹í™©í•˜ì§€ ë§ì. 

ë°ì´í„°ë¥¼ ìµœì†Œ í•œ ê°œ ì´ìƒ ë„£ì–´ì•¼ ëª©ë¡ì— í‘œì‹œëœë‹¤. 

í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ í™•ì¸í•˜ëŠ” ëª…ë ¹ì–´ëŠ” `db`

```sh
> db
nodejs
```

ë¹„ë¡ ë°ì´í„°ë² ì´ìŠ¤ ëª©ë¡ì—ëŠ” ì—†ì§€ë§Œ, í˜„ì¬ nodejs ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê³  ìˆìŒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

ì»¬ë ‰ì…˜ì€ ë”°ë¡œ ìƒì„±í•  í•„ìš”ê°€ ì—†ë‹¤. ë‹¤íë¨¼íŠ¸ë¥¼ ë„£ëŠ” ìˆœê°„ ì»¬ë ‰ì…˜ë„ ìë™ìœ¼ë¡œ ìƒì„±ëœë‹¤. í•˜ì§€ë§Œ ë‹¤ìŒê³¼ ê°™ì´ ì§ì ‘ ì»¬ë ‰ì…˜ì„ ìƒì„±í•˜ëŠ” ëª…ë ¹ì–´ê°€ ìˆë‹¤.

```sh
> db.createCollection('users')
{ "ok" : 1 }
> db.createCollection('comments')
{ "ok" : 1 }
```

ìƒì„±í•œ ì»¬ë ‰ì…˜ ëª©ë¡ì„ í™•ì¸ `show collections`

```sh
> show collections
comments
users
```

<br/>

---

<br/>

## **ğŸ’» CRUD ì‘ì—…í•˜ê¸°**

### **ğŸ³ Create**

- ëª½ê³ ë””ë¹„ëŠ” ì»¬ëŸ¼ì„ ì •ì˜í•˜ì§€ ì•Šì•„ë„ ë¨

- ììœ ë¡œì›€ì´ ì¥ì , ë¬´ì—‡ì´ ë“¤ì–´ì˜¬ì§€ ëª¨ë¥¸ë‹¤ëŠ” ë‹¨ì 

- ìë°”ìŠ¤í¬ë¦½íŠ¸ì˜ ìë£Œí˜•ì„ ë”°ë¦„(ì°¨ì´ì ë„ ì¡´ì¬)

- `ObjectId`: ëª½ê³ ë””ë¹„ì˜ ìë£Œí˜•ìœ¼ë¡œ ê³ ìœ  ì•„ì´ë”” ì—­í• ì„ í•¨

- save methodë¡œ ì €ì¥

```sh
$ mongosh
test> use nodejs;
switched to db nodejs
nodejs> db.users.insertOne({ name: 'zero', age: 24, married: false, comment: 'ì•ˆë…•í•˜ì„¸ìš”. ê°„ë‹¨íˆ ëª½ê³ ë””ë¹„ ì‚¬ìš© ë°©ë²•ì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤.', createdAt: new Date() });
{
  acknowledged: true,
  insertedId: ObjectId("5a1687007af03c3700826f70")
}
nodejs> db.users.insertOne({ name: 'nero', age: 32, married: true, comment: 'ì•ˆë…•í•˜ì„¸ìš”. zero ì¹œêµ¬ neroì…ë‹ˆë‹¤.', createdAt: new Date() });
{
  acknowledged: true,
  insertedId: ObjectId("62fba0deb068d84d69d7c740")
}
```

`db.ì»¬ë ‰ì…˜ëª….insertOne(ë‹¤íë¨¼íŠ¸)`ë¡œ ë‹¤íë¨¼íŠ¸ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤.

ìë°”ìŠ¤í¬ë¦½íŠ¸ ê°ì²´ì²˜ëŸ¼ ìƒì„±í•˜ë©´ ëœë‹¤.

<br/>

### **ğŸ³ Create(ê´€ê³„ ì„¤ì •)**

ì»¬ë ‰ì…˜ ê°„ ê´€ê³„ë¥¼ ê°•ìš”í•˜ëŠ” ì œí•œì´ ì—†ìœ¼ë¯€ë¡œ ì§ì ‘ ObjectIdë¥¼ ë„£ì–´ ì—°ê²°

ì‚¬ìš©ìì˜ ObjectIdë¥¼ ì°¾ì€ ë’¤ ëŒ“ê¸€ ì»¬ë ‰ì…˜ì— ë„£ìŒ

![image](https://github.com/leekoby/leekoby.github.io/assets/118284808/fe73ad54-050f-4375-ab05-e6a8b59b95ca)


<br/>

### **ğŸ³ Read**

findë¡œ ëª¨ë‘ ì¡°íšŒ, findOneìœ¼ë¡œ í•˜ë‚˜ë§Œ ì¡°íšŒ

```sh
nodejs> db.users.find({});
[
  { "_id" : ObjectId("5a1687007af03c3700826f70"), "name" : "zero", "age" : 24, "married" : false, "comment" : "ì•ˆë…•í•˜ì„¸ìš”. ê°„ë‹¨íˆ ëª½ê³ ë””ë¹„ ì‚¬ìš© ë°©ë²•ì„ ì•Œì•„ë´…ì‹œë‹¤.", "createdAt" : ISODate("2022-04-30T05:00:00Z") },
  { "_id" : ObjectId("5a16877b7af03c3700826f71"), "name" : "nero", "age" : 32, "married" : true, "comment" : "ì•ˆë…•í•˜ì„¸ìš”. zero ì¹œêµ¬ neroì…ë‹ˆë‹¤.", "createdAt" : ISODate("2017-11-23T01:00:00Z") }
]
nodejs> db.comments.find({})
[ { "_id" : ObjectId("5a1687e67af03c3700826f73"), "commenter" : ObjectId("5a1687007af03c3700826f70"), "comment" : "ì•ˆë…•í•˜ì„¸ìš”. zeroì˜ ëŒ“ê¸€ì…ë‹ˆë‹¤.", "createdAt" : ISODate("2022-04-30T05:30:00Z") } ]
```

find({})ëŠ” ì»¬ë ‰ì…˜ ë‚´ì˜ ëª¨ë“  ë‹¤íë¨¼íŠ¸ë¥¼ ì¡°íšŒí•˜ë¼ëŠ” ëœ»

<br/>

### **ğŸ³ Read(ì¡°ê±´)**

ë‘ ë²ˆì§¸ ì¸ìˆ˜ë¡œ ì¡°íšŒí•  í•„ë“œë¥¼ ì„ íƒí•  ìˆ˜ ìˆìŒ(1ì€ ì¶”ê°€, 0ì€ ì œì™¸)

```sh
nodejs> db.users.find({}, { _id: 0, name: 1, married: 1 });
[
  { "name" : "zero", "married" : false },
  { "name" : "nero", "married" : true }
]
```

ì²« ë²ˆì§¸ ì¸ìˆ˜ë¡œ ì¡°íšŒ ì¡°ê±´ ì…ë ¥ ê°€ëŠ¥

$gtë‚˜ $orê°™ì€ ì¡°ê±´ ì—°ì‚°ì ì‚¬ìš©

`$gt`(ì´ˆê³¼), `$gte`(ì´ìƒ), `$lt`(ë¯¸ë§Œ), `$lte`(ì´í•˜), `$ne`(ê°™ì§€ ì•ŠìŒ), `$or`(ë˜ëŠ”), `$in`(ë°°ì—´ ìš”ì†Œ ì¤‘ í•˜ë‚˜) ë“±ì´ ìˆë‹¤.

```sh
nodejs> db.users.find({ age: { $gt: 0 }, married: true }, { _id: 0, name: 1, age: 1 });
[ { "name" : "nero", "age" : 32 } ]
```

```sh
nodejs> db.users.find({ $or: [{ age: { $gt: 30 } }, { married: false }] }, { _id: 0, name: 1, age: 1 });
[
  { "name" : "zero", "age" : 24 },
  { "name" : "nero", "age" : 32 }
]
```

ì •ë ¬ì€ sort ë©”ì„œë“œë¡œ í•¨

`-1` ì€ ë‚´ë¦¼ì°¨ìˆœ, `1`ì€ ì˜¤ë¦„ì°¨ìˆœ

```sh
nodejs> db.users.find({}, { _id: 0, name:f, age: 1}).sort({ age: -1 })
[
  { "name" : "nero", "age" : 32 },
  { "name" : "zero", "age" : 24 }
]
```

limit ë©”ì„œë“œë¡œ ì¡°íšŒí•  ë‹¤íë¨¼íŠ¸ ê°œìˆ˜ ì œí•œ

```sh
nodejs> db.users.find({}, { _id: 0, name: 1, age: 1 }).sort({ age: -1 }).limit(1)
[ { "name" : "nero", "age" : 32 } ]
```

skip ë©”ì„œë“œë¡œ ê±´ë„ˆë›¸ ë‹¤íë¨¼íŠ¸ ê°œìˆ˜ ì œê³µ

```sh
nodejs> db.users.find({}, { _id: 0, name: 1, age: 1 }).sort({ age: -1 }).limit(1).skip(1)
[ { "name" : "zero", "age" : 24 } ]
```

<br/>

### **ğŸ³ Update**

ì²« ë²ˆì§¸ ê°ì²´ëŠ” ìˆ˜ì •í•  ë‹¤íë¨¼íŠ¸ë¥¼ ì§€ì •í•˜ëŠ” ê°ì²´

ë‘ ë²ˆì§¸ ê°ì²´ëŠ” ìˆ˜ì •í•  ë‚´ìš©ì„ ì…ë ¥í•˜ëŠ” ê°ì²´

`$set`ì„ ë¶™ì´ì§€ ì•Šìœ¼ë©´ ë‹¤íë¨¼íŠ¸ ì „ì²´ê°€ ëŒ€ì²´ë˜ë¯€ë¡œ ì£¼ì˜

í•˜ë‚˜ë§Œ ìˆ˜ì •í•  ë•Œ updateOne, ì—¬ëŸ¬ ê°œ ìˆ˜ì •í•  ë•Œ updateMany

```sh
nodejs> db.users.updateOne({ name: 'nero' }, { $set: { comment: 'ì•ˆë…•í•˜ì„¸ìš” ì´ í•„ë“œë¥¼ ë°”ê¿”ë³´ê² ìŠµë‹ˆë‹¤!' } });
{
  acknowledged: true,
  insertedId: null,
  matchedCount: 1,
  modifiedCount: 0,
  upsertedCount: 0
}
```

<br/>

### **ğŸ³ Delete**

í•˜ë‚˜ë§Œ ìˆ˜ì •í•  ë•Œ deleteOne, ì—¬ëŸ¬ ê°œ ìˆ˜ì •í•  ë•Œ deleteMany

ì²« ë²ˆì§¸ ì¸ìˆ˜ë¡œ ì‚­ì œí•  ëŒ€ìƒ ì¡°ê±´ ì œê³µ

ì„±ê³µ ì‹œ ì‚­ì œëœ ê°œìˆ˜ê°€ ë°˜í™˜ë¨

```sh
nodejs> db.users.deleteOne({ name: 'nero' })
{ acknowledged: true, deletedCount: 1 }
```

<br/>

---

<br/>

## **ğŸ’» ëª½êµ¬ìŠ¤ ì‚¬ìš©í•˜ê¸°**

### **ğŸ³ ëª½êµ¬ìŠ¤ ODM**

ëª½ê³ ë””ë¹„ ì‘ì—…ì„ ì‰½ê²Œ í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” ë¼ì´ë¸ŒëŸ¬ë¦¬

`ODM`(Object Document Mapping): ê°ì²´ì™€ ë‹¤íë¨¼íŠ¸ë¥¼ ë§¤í•‘(1ëŒ€1 ì§ì§€ìŒ)

ëª½ê³ ë””ë¹„ì— ì—†ì–´ ë¶ˆí¸í•œ ê¸°ëŠ¥ë“¤ì„ ëª½êµ¬ìŠ¤ê°€ ë³´ì™„

í…Œì´ë¸”ê³¼ ìœ ì‚¬í•œ ê¸°ëŠ¥, JOIN ê¸°ëŠ¥ ì¶”ê°€

[ì†ŒìŠ¤ ì½”ë“œ ì°¸ê³ ](https://github.com/zerocho/nodejs-book/tree/master/ch8/8.6/learn-mongoose){:target="_blank"}

- í”„ë¡œì íŠ¸ ì„¸íŒ… í›„, ì½˜ì†”ì„ í†µí•´ ê²½ë¡œë¡œ ì´ë™í•œ í›„ package.json ì„¤ì¹˜

ğŸ”» pakage.json

```js
{
  "name": "learn-mongoose",
  "version": "0.0.1",
  "description": "ëª½êµ¬ìŠ¤ë¥¼ ë°°ìš°ì",
  "main": "app.js",
  "scripts": {
    "start": "nodemon app"
  },
  "author": "ZeroCho",
  "license": "MIT"
}
```

ì„¤ì¹˜

```sh
$ npm i express morgan nunjucks mongoose
$ npm i -D nodemon
```

<br/>

### **ğŸ³ ëª½ê³ ë””ë¹„ ì—°ê²°í•˜ê¸°**

ëª½êµ¬ìŠ¤ë¥¼ í†µí•´ ëª½ê³ ë””ë¹„ ì—°ê²°í•˜ê¸°

- ì¸ì¦ì€ admin ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ, ì„œë¹„ìŠ¤ëŠ” dbName ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ

ğŸ”»scehmas/index.js

```js
const mongoose = require('mongoose');

const connect = () => {
  if (process.env.NODE_ENV !== 'production') {
    mongoose.set('debug', true);
  }
  mongoose.connect('mongodb://root:nodejsbook@localhost:27017/admin', {
    dbName: 'nodejs',
    useNewUrlParser: true,
    useCreateIndex: true,
  }, (error) => {
    if (error) {
      console.log('ëª½ê³ ë””ë¹„ ì—°ê²° ì—ëŸ¬', error);
    } else {
      console.log('ëª½ê³ ë””ë¹„ ì—°ê²° ì„±ê³µ');
    }
  });
};

mongoose.connection.on('error', (error) => {
  console.error('ëª½ê³ ë””ë¹„ ì—°ê²° ì—ëŸ¬', error);
});
mongoose.connection.on('disconnected', () => {
  console.error('ëª½ê³ ë””ë¹„ ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤. ì—°ê²°ì„ ì¬ì‹œë„í•©ë‹ˆë‹¤.');
  connect();
});

module.exports = connect;
```

<br/>

### **ğŸ³ ì•±ê³¼ ì—°ê²°í•˜ê¸°**

app.jsë¡œ ì—°ê²°

- schemas/index.jsì˜ í•¨ìˆ˜ê°€ ì‹¤í–‰ë¨

- mongoose.connect í•¨ìˆ˜ê°€ ëª½ê³ ë””ë¹„ì— ì—°ê²°ì„ ì‹œë„

- mongoose.setì€ ë””ë²„ê¹… ëª¨ë“œ(ëª¨ë“œë¥¼ ì¼°ì„ ë•Œ ì½˜ì†”ì— ì¿¼ë¦¬ê°€ ì°í˜)

- ì—°ê²°ì´ ëŠê¸°ë©´(disconnection) ë‹¤ì‹œ ì—°ê²°ì„ ì‹œë„

ğŸ”»app.js

```js
const express = require('express');
const path = require('path');
const morgan = require('morgan');
const nunjucks = require('nunjucks');

const connect = require('./schemas');

const app = express();
app.set('port', process.env.PORT || 3002);
app.set('view engine', 'html');
nunjucks.configure('views', {
  express: app,
  watch: true,
});
connect();

app.use(morgan('dev'));
app.use(express.static(path.join(__dirname, 'public')));
app.use(express.json());
app.use(express.urlencoded({ extended: false }));

app.use((req, res, next) => {
  const error =  new Error(`${req.method} ${req.url} ë¼ìš°í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
  error.status = 404;
  next(error);
});

app.use((err, req, res, next) => {
  res.locals.message = err.message;
  res.locals.error = process.env.NODE_ENV !== 'production' ? err : {};
  res.status(err.status || 500);
  res.render('error');
});

app.listen(app.get('port'), () => {
  console.log(app.get('port'), 'ë²ˆ í¬íŠ¸ì—ì„œ ëŒ€ê¸° ì¤‘');
});
```

<br/>

### **ğŸ³ ìŠ¤í‚¤ë§ˆ ì •ì˜í•˜ê¸°**

schemas í´ë” ì•ˆì— ì‘ì„±

- MySQLì˜ í…Œì´ë¸”ì²˜ëŸ¼ ì •í•´ì§„ ë°ì´í„°ë§Œ ë“¤ì–´ê°ˆ ìˆ˜ ìˆê²Œ ê°•ì œí•¨

- typeì€ ìë£Œí˜•, requireëŠ” í•„ìˆ˜ ì—¬ë¶€ defaultëŠ” ê¸°ë³¸ê°’, uniqueëŠ” ê³ ìœ  ì—¬ë¶€

ğŸ”»schemas/user.js

```js
const mongoose = require('mongoose');

const { Schema } = mongoose;
const userSchema = new Schema({
  name: {
    type: String,
    required: true,
    unique: true,
  },
  age: {
    type: Number,
    required: true,
  },
  married: {
    type: Boolean,
    required: true,
  },
  comment: String,
  createdAt: {
    type: Date,
    default: Date.now,
  },
});

module.exports = mongoose.model('User', userSchema);
```

ğŸ”»schemas/comment.js

```js
const mongoose = require('mongoose');

const { Schema } = mongoose;
const { Types: { ObjectId } } = Schema;
const commentSchema = new Schema({
  commenter: {
    type: ObjectId,
    required: true,
    ref: 'User',
  },
  comment: {
    type: String,
    required: true,
  },
  createdAt: {
    type: Date,
    default: Date.now,
  },
});

module.exports = mongoose.model('Comment', commentSchema);
```

<br/>

### **ğŸ³ ë¼ìš°í„° ì‘ì„±**

í”„ë¡ íŠ¸ì—”ë“œ ì½”ë“œëŠ” ì„œë²„ì— ìš”ì²­ì„ ë³´ë‚´ëŠ” AJAX ìš”ì²­ ìœ„ì£¼ë¡œ

ì„œë²„ ì½”ë“œëŠ” ì‘ë‹µì„ ë³´ë‚´ëŠ” ë¼ìš°í„° ìœ„ì£¼ë¡œ ì‚´í´ë³´ê¸°

[ë‹¤ë¥¸ ì†ŒìŠ¤ ì½”ë“œ ì°¸ì¡° 8.6.3](https://github.com/zerocho/nodejs-book){:target="_blank"}

ğŸ”»routes.index.js

```js
const express = require('express');
const User = require('../schemas/user');

const router = express.Router();

router.get('/', async (req, res, next) => {
  try {
    const users = await User.find({});
    res.render('mongoose', { users });
  } catch (err) {
    console.error(err);
    next(err);
  }
});

module.exports = router;
```


<br/>

### **ğŸ³ ì‚¬ìš©ì ë¼ìš°í„°**

router.get, post, put, patch, delete ë¼ìš°í„° ì‘ì„±

ğŸ”»routes/users.js

```js
const express = require('express');
const User = require('../schemas/user');
const Comment = require('../schemas/comment');

const router = express.Router();

router.route('/')
  .get(async (req, res, next) => {
    try {
      const users = await User.find({});
      res.json(users);
    } catch (err) {
      console.error(err);
      next(err);
    }
  })
  .post(async (req, res, next) => {
    try {
      const user = await User.create({
        name: req.body.name,
        age: req.body.age,
        married: req.body.married,
      });
      console.log(user);
      res.status(201).json(user);
    } catch (err) {
      console.error(err);
      next(err);
    }
  });

router.get('/:id/comments', async (req, res, next) => {
  try {
    const comments = await Comment.find({ commenter: req.params.id })
      .populate('commenter');
    console.log(comments);
    res.json(comments);
  } catch (err) {
    console.error(err);
    next(err);
  }
});

module.exports = router;
```

<br/>

### **ğŸ³ ëŒ“ê¸€ ë¼ìš°í„°**

router.get, post, put, patch, delete ë¼ìš°í„° ì‘ì„±

ğŸ”»routes/comment.js

```js
const express = require('express');
const Comment = require('../schemas/comment');

const router = express.Router();

router.post('/', async (req, res, next) => {
  try {
    const comment = await Comment.create({
      commenter: req.body.id,
      comment: req.body.comment,
    });
    console.log(comment);
    const result = await Comment.populate(comment, { path: 'commenter' });
    res.status(201).json(result);
  } catch (err) {
    console.error(err);
    next(err);
  }
});

router.route('/:id')
  .patch(async (req, res, next) => {
    try {
      const result = await Comment.update({
        _id: req.params.id,
      }, {
        comment: req.body.comment,
      });
      res.json(result);
    } catch (err) {
      console.error(err);
      next(err);
    }
  })
  .delete(async (req, res, next) => {
    try {
      const result = await Comment.remove({ _id: req.params.id });
      res.json(result);
    } catch (err) {
      console.error(err);
      next(err);
    }
  });

module.exports = router;
```
<br/>

### **ğŸ³ ë¼ìš°í„° ì—°ê²°í•˜ê¸°**

app.jsì— ì—°ê²°

ğŸ”»app.js

```js
const express = require('express');
const path = require('path');
const morgan = require('morgan');
const nunjucks = require('nunjucks');

const connect = require('./schemas');
const indexRouter = require('./routes/index');
const usersRouter = require('./routes/users');
const commentsRouter = require('./routes/comments');

const app = express();
app.set('port', process.env.PORT || 3002);
app.set('view engine', 'html');
nunjucks.configure('views', {
  express: app,
  watch: true,
});
connect();

app.use(morgan('dev'));
app.use(express.static(path.join(__dirname, 'public')));
app.use(express.json());
app.use(express.urlencoded({ extended: false }));

app.use('/', indexRouter);
app.use('/users', usersRouter);
app.use('/comments', commentsRouter);

app.use((req, res, next) => {
  const error =  new Error(`${req.method} ${req.url} ë¼ìš°í„°ê°€ ì—†ìŠµë‹ˆë‹¤.`);
  error.status = 404;
  next(error);
});
...
```

<br/>

### **ğŸ³ ì„œë²„ ì—°ê²°í•˜ê¸°**

npm start í›„ localhost:3002ì— ì ‘ì†

ì½˜ì†”ì— ì°íˆëŠ” ëª½ê³ ë””ë¹„ ì¿¼ë¦¬ í™•ì¸

```sh
$ npm start
> learn-mongoose@0.0.1 start 
> nodemon app

[nodemon] 2.0.16
[nodemon] to restart at any time, enter `rs`
[nodemon] watching: *.*
[nodemon] watching extensions: js,mjs,json
[nodemon] starting `node app.js`
3002 ë²ˆ í¬íŠ¸ì—ì„œ ëŒ€ê¸° ì¤‘
ëª½ê³ ë””ë¹„ ì—°ê²° ì„±ê³µ
Mongoose: users.createIndex({ name: 1 }, { unique: true, background: true })
```

![ëª½êµ¬ìŠ¤ ì„œë²„ í™”ë©´](https://github.com/leekoby/leekoby.github.io/assets/118284808/6965f447-273d-4a9a-8fa9-d4bd8668c36e)

<br/>

---

<br/>

## **ğŸ’» í•¨ê»˜ ë³´ë©´ ì¢‹ì€ ìë£Œ**

> [ëª½ê³ ë””ë¹„ ë¬¸ì„œ](https://docs.mongodb.com){:target="_blank"}
{:.prompt-info}

> [ëª½ê³ ë””ë¹„ ìë£Œí˜• ì„¤ëª…](https://docs.mongodb.com/manual/reference/bson-types){:target="_blank"}
{:.prompt-info}

> [ì»´í¼ìŠ¤ ë§¤ë‰´ì–¼](https://docs.mongodb.com/compass/master){:target="_blank"}
{:.prompt-info}

> [ëª½êµ¬ìŠ¤ ë¬¸ì„œ](http://mongoosejs.com/docs/guide.html){:target="_blank"}
{:.prompt-info}

<br/>

---

<br/>

## ğŸ“š **ë ˆí¼ëŸ°ìŠ¤**

>ì¡°í˜„ì˜. Node.js êµê³¼ì„œ = Node.js Textbook / ì¡°í˜„ì˜ ì§€ìŒ (2022). Print.
{:.prompt-info}

>[[ë¦¬ë‰´ì–¼] Node.js êµê³¼ì„œ - ê¸°ë³¸ë¶€í„° í”„ë¡œì íŠ¸ ì‹¤ìŠµê¹Œì§€](https://www.inflearn.com/course/%EB%85%B8%EB%93%9C-%EA%B5%90%EA%B3%BC%EC%84%9C){:target="_blank"}
{:.prompt-info}